<div class="d-flex mb-3 p-3 border border-opacity-100 bg-white rounded ">
    <select id="depId" name="depId" class="form-select" style="width: 150px;">
    </select>
</div>

<div class="p-3 mb-3 border border-opacity-100 bg-white rounded">
    <div class="container">
        <div class="row mt-5">
            <div class="col-md-4">
                <h2 class="text-center mb-4">可選課程</h2>
                <ul id="availableCourses" class="list-group">
                    <!-- 預設資料 -->
                </ul>
            </div>
            <div class="col-md-4 d-flex flex-column justify-content-center align-items-center">
                <button id="addCourse" class="btn btn-primary mb-2">加選 &gt;&gt;</button>
                <button id="removeCourse" class="btn btn-danger mt-2">&lt;&lt; 退選</button>
            </div>
            <div class="col-md-4">
                <h2 class="text-center mb-4">已選課程</h2>
                <ul id="selectedCourses" class="list-group">
                    <!-- 已選課程列表 -->
                </ul>
            </div>
        </div>
        <div class="row mt-5">
            <div class="col-md-12">
                <div class="p-3 mb-3 border border-opacity-100 bg-white rounded">
                    <h2 class="text-center mb-4">課表</h2>
                    <table class="table table-bordered table-striped schedule-table text-center">
                        <thead>
                            <tr>
                                <th></th>
                                <th>星期一</th>
                                <th>星期二</th>
                                <th>星期三</th>
                                <th>星期四</th>
                                <th>星期五</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleBody">
                            <tr>
                                <th>08:00 - 08:50<br>第一節</th>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                            <tr>
                                <th>09:00 - 09:50<br>第二節</th>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                            <tr>
                                <th>10:00 - 10:50<br>第三節</th>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                            <tr>
                                <th>11:00 - 11:50<br>第四節</th>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                            <tr>
                                <th colspan="6" class="text-center bg-light">中午休息</th>
                            </tr>
                            <tr>
                                <th>13:00 - 13:50<br>第五節</th>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                            <tr>
                                <th>14:00 - 14:50<br>第六節</th>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                            <tr>
                                <th>15:00 - 15:50<br>第七節</th>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                            <tr>
                                <th>16:00 - 16:50<br>第八節</th>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(async function() {
        await loadDepartment();
        await findSchedule();
        findAllCourse();
        
        // 點擊課程項目時選中課程
        $(document).on('click', '.course-item', function() {
            $('.course-item').removeClass('active');
            $(this).addClass('active');
        });

        // 下拉選單
        $('#depId').on('change', function() {
            findAllCourse();
        });

        // 加選課程
        $('#addCourse').on('click', async function() {
            var selectedCourse = $('#availableCourses .active');
            if (selectedCourse.length > 0) {
                var course = selectedCourse.data('course');
                var courseOfWeek = course.courseOfWeek;
                var courseStart = course.courseStart;
                var courseEnd = course.courseEnd;
                var courseName = course.courseName;
                var column;
                switch (courseOfWeek) {
                    case 'Monday':
                        column = 0;
                        break;
                    case 'Tuesday':
                        column = 1;
                        break;
                    case 'Wednesday':
                        column = 2;
                        break;
                    case 'Thursday':
                        column = 3;
                        break;
                    case 'Friday':
                        column = 4;
                        break;
                }

                for (var i = courseStart; i <= courseEnd; i++) {
                    var rowIndex = courseStart < 5 ? i-1 : i;
                    var cell = $('#scheduleBody').find('tr').eq(rowIndex).find('td').eq(column);
                    if (!cell.text() == '') {
                        alert('該時段已有課程');
                        return;
                    }
                    cell.html(courseName);
                }                

                const response = await fetch(`${ip}/select/insertCourse`, {
                    method : 'POST',
                    headers : {
                        'Authorization': `Bearer ${token}`,
                    },
                    body : JSON.stringify(course)
                });

                const {state, message, data} = await response.json();

                if (state) {
                    alert(message);
                }

                selectedCourse.removeClass('active').appendTo('#selectedCourses');
            } else {
                alert('請選擇一門課程');
            }
        });

        // 退選課程
        $('#removeCourse').on('click', async function() {
            var selectedCourse = $('#selectedCourses .active');
            if (selectedCourse.length > 0) {
                var course = selectedCourse.data('course');
                var courseOfWeek = course.courseOfWeek;
                var courseStart = course.courseStart;
                var courseEnd = course.courseEnd;
                var courseName = course.courseName;
                var column;
                switch (courseOfWeek) {
                    case 'Monday':
                        column = 0;
                        break;
                    case 'Tuesday':
                        column = 1;
                        break;
                    case 'Wednesday':
                        column = 2;
                        break;
                    case 'Thursday':
                        column = 3;
                        break;
                    case 'Friday':
                        column = 4;
                        break;
                }

                for (var i = courseStart; i <= courseEnd; i++) {
                    var rowIndex = courseStart < 5 ? i-1 : i;                    
                    $('#scheduleBody').find('tr').eq(rowIndex).find('td').eq(column).html('');
                }

                const response = await fetch(`${ip}/select/deleteCourse`, {
                    method : 'DELETE',
                    headers : {
                        'Authorization': `Bearer ${token}`,
                    },
                    body : JSON.stringify(course)
                });

                const {state, message, data} = await response.json();

                if (state) {
                    alert(message);
                }

                selectedCourse.removeClass('active').appendTo('#availableCourses');
            } else {
                alert('請選擇一門已選課程');
            }
        });
    });

    var findSchedule = async function() {
        $('#scheduleBody').find('td').html('');
        var param = {
            'userId' : `${userId}`,
            'courseYear' : '112',
            'courseSemester' : '1'
        }

        var queryString = new URLSearchParams(param).toString();

        const response = await fetch(`${ip}/course/findSchedule?${queryString}`, {
            headers : {
                'Authorization': `Bearer ${token}`,
            }
        });

        const {state, message, data} = await response.json();

        data.forEach(obj => {
            var column;
            switch (obj.courseOfWeek) {
                case 'Monday':
                    column = 0;
                    break;
                case 'Tuesday':
                    column = 1;
                    break;
                case 'Wednesday':
                    column = 2;
                    break;
                case 'Thursday':
                    column = 3;
                    break;
                case 'Friday':
                    column = 4;
                    break;
            }

            for (var i = obj.courseStart; i <= obj.courseEnd; i++) {
                var rowIndex = obj.courseStart < 5 ? i-1 : i;
                $('#scheduleBody').find('tr').eq(rowIndex).find('td').eq(column).html(obj.courseName);
            }
        });
    }

    var findAllCourse = async function() {
        var param = {
            courseRequired : '2',
            depId : $('#depId').val()
        }
        var queryString = new URLSearchParams(param).toString();
        const response = await fetch(`${ip}/course/findCourseOfferingInfo?${queryString}`, {
            headers : {
                'Authorization': `Bearer ${token}`
            }
        });
        const {state, message, data} = await response.json();
        $('#availableCourses').html('');
        data.forEach(obj => {
            var jsonStr = JSON.stringify(obj);
            $('#availableCourses').append(`
                <li class="list-group-item course-item" data-course='${jsonStr}'">${obj.courseName} - ${obj.courseTime}</li>
            `);
        });        
    }
</script>
